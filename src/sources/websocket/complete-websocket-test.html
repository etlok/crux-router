<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete WebSocket Authentication Test</title>
    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: flex;
            gap: 20px;
        }
        .column {
            flex: 1;
        }
        .panel {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        h2 {
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        #messages {
            height: 300px;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: auto;
            margin-bottom: 10px;
        }
        input, button, textarea, select {
            margin-bottom: 10px;
            padding: 8px;
        }
        textarea {
            width: 100%;
            height: 100px;
        }
        button {
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            margin-right: 5px;
        }
        button:disabled {
            background-color: #cccccc;
        }
        .message {
            padding: 5px;
            margin-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        .message.sent {
            background-color: #f0f8ff;
        }
        .message.received {
            background-color: #f0fff0;
        }
        .message.error {
            background-color: #fff0f0;
        }
        .message.api {
            background-color: #fff8e0;
        }
        .message .timestamp {
            color: #999;
            font-size: 0.8em;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        .api-url {
            width: 80%;
        }
    </style>
</head>
<body>
    <h1>Complete WebSocket Authentication Test</h1>
    
    <div class="container">
        <!-- API Authentication Column -->
        <div class="column">
            <div class="panel">
                <h2>1. API Authentication</h2>
                <div class="form-group">
                    <label for="apiUrl">API Base URL:</label>
                    <input type="text" id="apiUrl" value="http://localhost:3000" class="api-url">
                </div>
                
                <div class="panel">
                    <h3>Login / Get Token</h3>
                    <div class="form-group">
                        <label for="username">Username:</label>
                        <input type="text" id="username" value="testuser">
                    </div>
                    <div class="form-group">
                        <label for="password">Password:</label>
                        <input type="password" id="password" value="password">
                    </div>
                    <button id="loginBtn">Login</button>
                    <button id="getTestTokenBtn">Get Test Token</button>
                </div>
                
                <div class="panel">
                    <h3>Token Management</h3>
                    <div class="form-group">
                        <label for="jwtToken">JWT Token:</label>
                        <textarea id="jwtToken" placeholder="Your JWT token will appear here"></textarea>
                    </div>
                    <button id="validateTokenBtn">Validate Token</button>
                    <button id="revokeTokenBtn">Revoke Token</button>
                    <button id="decodeTokenBtn">Decode Token</button>
                </div>
            </div>
            
            <div class="panel">
                <h2>3. API Testing</h2>
                <div class="form-group">
                    <label for="apiEndpoint">Endpoint:</label>
                    <select id="apiEndpoint">
                        <option value="connections">Get Connections</option>
                        <option value="broadcast">Broadcast Message</option>
                    </select>
                </div>
                <div id="broadcastParams" style="display: none;">
                    <div class="form-group">
                        <label for="broadcastEvent">Event:</label>
                        <input type="text" id="broadcastEvent" value="server_notification">
                    </div>
                    <div class="form-group">
                        <label for="broadcastRoom">Room (optional):</label>
                        <input type="text" id="broadcastRoom">
                    </div>
                    <div class="form-group">
                        <label for="broadcastPayload">Payload (JSON):</label>
                        <textarea id="broadcastPayload">{
  "message": "Test broadcast message",
  "importance": "high"
}</textarea>
                    </div>
                </div>
                <button id="callApiBtn">Call API</button>
            </div>
        </div>
        
        <!-- WebSocket Column -->
        <div class="column">
            <div class="panel">
                <h2>2. WebSocket Connection</h2>
                <div class="form-group">
                    <label for="wsUrl">WebSocket URL:</label>
                    <input type="text" id="wsUrl" value="http://localhost:3000" class="api-url">
                </div>
                <div class="form-group">
                    <label for="authMethod">Authentication Method:</label>
                    <select id="authMethod">
                        <option value="connection">On Connection</option>
                        <option value="event">Post-Connection</option>
                    </select>
                </div>
                <button id="connectBtn">Connect</button>
                <button id="disconnectBtn" disabled>Disconnect</button>
                <button id="wsAuthenticateBtn" disabled>Authenticate</button>
                
                <div class="panel">
                    <h3>Room Management</h3>
                    <div class="form-group">
                        <label for="roomName">Room Name:</label>
                        <input type="text" id="roomName" value="test-room">
                        <button id="joinRoomBtn" disabled>Join Room</button>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <h2>4. WebSocket Events</h2>
                <div class="form-group">
                    <label for="wsEventName">Event Name:</label>
                    <input type="text" id="wsEventName" value="test_event">
                </div>
                <div class="form-group">
                    <label for="wsEventPayload">Event Payload (JSON):</label>
                    <textarea id="wsEventPayload">{
  "message": "Hello WebSocket Server!",
  "timestamp": "2025-09-07T12:00:00Z"
}</textarea>
                </div>
                <button id="sendEventBtn" disabled>Send Event</button>
            </div>
        </div>
    </div>
    
    <h2>Activity Log</h2>
    <div id="messages"></div>
    <button id="clearMessagesBtn">Clear Log</button>
    
    <script>
        // Global variables
        let socket = null;
        let isConnected = false;
        let isAuthenticated = false;
        let currentToken = '';
        
        // DOM elements - API
        const apiUrl = document.getElementById('apiUrl');
        const username = document.getElementById('username');
        const password = document.getElementById('password');
        const jwtToken = document.getElementById('jwtToken');
        const loginBtn = document.getElementById('loginBtn');
        const getTestTokenBtn = document.getElementById('getTestTokenBtn');
        const validateTokenBtn = document.getElementById('validateTokenBtn');
        const revokeTokenBtn = document.getElementById('revokeTokenBtn');
        const decodeTokenBtn = document.getElementById('decodeTokenBtn');
        const apiEndpoint = document.getElementById('apiEndpoint');
        const broadcastParams = document.getElementById('broadcastParams');
        const broadcastEvent = document.getElementById('broadcastEvent');
        const broadcastRoom = document.getElementById('broadcastRoom');
        const broadcastPayload = document.getElementById('broadcastPayload');
        const callApiBtn = document.getElementById('callApiBtn');
        
        // DOM elements - WebSocket
        const wsUrl = document.getElementById('wsUrl');
        const authMethod = document.getElementById('authMethod');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const wsAuthenticateBtn = document.getElementById('wsAuthenticateBtn');
        const roomName = document.getElementById('roomName');
        const joinRoomBtn = document.getElementById('joinRoomBtn');
        const wsEventName = document.getElementById('wsEventName');
        const wsEventPayload = document.getElementById('wsEventPayload');
        const sendEventBtn = document.getElementById('sendEventBtn');
        const messagesDiv = document.getElementById('messages');
        const clearMessagesBtn = document.getElementById('clearMessagesBtn');
        
        // Event handlers for API Authentication
        loginBtn.addEventListener('click', async () => {
            try {
                logMessage('Attempting to login...', 'api');
                
                const response = await axios.post(`${apiUrl.value}/websocket/token`, {
                    username: username.value,
                    password: password.value
                });
                
                logMessage(`Login response: ${JSON.stringify(response.data)}`, 'received');
                
                if (response.data.status === 'success' && response.data.token) {
                    currentToken = response.data.token;
                    jwtToken.value = response.data.token;
                    logMessage('Successfully obtained token', 'api');
                }
            } catch (err) {
                logMessage(`Login error: ${err.response?.data?.message || err.message}`, 'error');
            }
        });
        
        getTestTokenBtn.addEventListener('click', async () => {
            try {
                logMessage('Getting test token...', 'api');
                
                const response = await axios.get(`${apiUrl.value}/websocket/test-token`, {
                    params: { username: username.value }
                });
                
                logMessage(`Test token response: ${JSON.stringify(response.data)}`, 'received');
                
                if (response.data.status === 'success' && response.data.token) {
                    currentToken = response.data.token;
                    jwtToken.value = response.data.token;
                    logMessage('Successfully obtained test token', 'api');
                }
            } catch (err) {
                logMessage(`Test token error: ${err.response?.data?.message || err.message}`, 'error');
            }
        });
        
        validateTokenBtn.addEventListener('click', async () => {
            try {
                if (!jwtToken.value) {
                    logMessage('No token to validate', 'error');
                    return;
                }
                
                logMessage('Validating token...', 'api');
                
                const response = await axios.post(`${apiUrl.value}/websocket/validate-token`, {
                    token: jwtToken.value
                });
                
                logMessage(`Validation response: ${JSON.stringify(response.data)}`, 'received');
            } catch (err) {
                logMessage(`Validation error: ${err.response?.data?.message || err.message}`, 'error');
            }
        });
        
        revokeTokenBtn.addEventListener('click', async () => {
            try {
                if (!jwtToken.value) {
                    logMessage('No token to revoke', 'error');
                    return;
                }
                
                logMessage('Revoking token...', 'api');
                
                const response = await axios.post(`${apiUrl.value}/websocket/revoke-token`, {
                    token: jwtToken.value
                });
                
                logMessage(`Revocation response: ${JSON.stringify(response.data)}`, 'received');
                
                if (response.data.status === 'success') {
                    logMessage('Token has been revoked. You will need to get a new token.', 'api');
                }
            } catch (err) {
                logMessage(`Revocation error: ${err.response?.data?.message || err.message}`, 'error');
            }
        });
        
        decodeTokenBtn.addEventListener('click', () => {
            try {
                if (!jwtToken.value) {
                    logMessage('No token to decode', 'error');
                    return;
                }
                
                // Simple client-side JWT decoding (just for display, not for verification)
                const tokenParts = jwtToken.value.split('.');
                if (tokenParts.length !== 3) {
                    throw new Error('Invalid token format');
                }
                
                const payload = JSON.parse(atob(tokenParts[1]));
                logMessage(`Token payload: ${JSON.stringify(payload, null, 2)}`, 'received');
            } catch (err) {
                logMessage(`Decoding error: ${err.message}`, 'error');
            }
        });
        
        // Event handlers for API Testing
        apiEndpoint.addEventListener('change', () => {
            broadcastParams.style.display = apiEndpoint.value === 'broadcast' ? 'block' : 'none';
        });
        
        callApiBtn.addEventListener('click', async () => {
            try {
                switch (apiEndpoint.value) {
                    case 'connections':
                        const connResponse = await axios.get(`${apiUrl.value}/websocket/connections`);
                        logMessage(`Connections API response: ${JSON.stringify(connResponse.data)}`, 'received');
                        break;
                        
                    case 'broadcast':
                        let payload = {};
                        try {
                            payload = JSON.parse(broadcastPayload.value);
                        } catch (e) {
                            logMessage('Invalid JSON payload', 'error');
                            return;
                        }
                        
                        const broadcastData = {
                            event: broadcastEvent.value,
                            data: payload
                        };
                        
                        if (broadcastRoom.value) {
                            broadcastData.room = broadcastRoom.value;
                        }
                        
                        logMessage(`Broadcasting: ${JSON.stringify(broadcastData)}`, 'sent');
                        const broadcastResponse = await axios.post(`${apiUrl.value}/websocket/broadcast`, broadcastData);
                        logMessage(`Broadcast API response: ${JSON.stringify(broadcastResponse.data)}`, 'received');
                        break;
                }
            } catch (err) {
                logMessage(`API call error: ${err.response?.data?.message || err.message}`, 'error');
            }
        });
        
        // Event handlers for WebSocket
        connectBtn.addEventListener('click', () => {
            try {
                // Cleanup any existing connection
                if (socket) {
                    socket.disconnect();
                }
                
                logMessage('Connecting to WebSocket server...', 'system');
                
                // Connection options
                const options = {
                    transports: ['websocket']
                };
                
                // If using connection authentication
                if (authMethod.value === 'connection' && jwtToken.value) {
                    options.auth = { token: jwtToken.value };
                    logMessage('Using token in connection auth', 'system');
                }
                
                // Connect to the server
                socket = io(wsUrl.value, options);
                
                // Connection events
                socket.on('connect', () => {
                    isConnected = true;
                    logMessage(`Connected to WebSocket server. Socket ID: ${socket.id}`, 'system');
                    updateButtonStates();
                    
                    // If using connection authentication and token was provided
                    if (authMethod.value === 'connection' && jwtToken.value) {
                        isAuthenticated = true;
                        logMessage('Authenticated via connection token', 'system');
                        updateButtonStates();
                    }
                });
                
                socket.on('disconnect', () => {
                    isConnected = false;
                    isAuthenticated = false;
                    logMessage('Disconnected from WebSocket server', 'system');
                    updateButtonStates();
                });
                
                socket.on('connect_error', (err) => {
                    logMessage(`Connection error: ${err.message}`, 'error');
                    updateButtonStates();
                });
                
                // Listen for incoming events
                socket.on('outgoing_event', (data) => {
                    logMessage(`Received event: ${JSON.stringify(data)}`, 'received');
                });
                
            } catch (err) {
                logMessage(`Error creating connection: ${err.message}`, 'error');
            }
        });
        
        disconnectBtn.addEventListener('click', () => {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
        });
        
        wsAuthenticateBtn.addEventListener('click', () => {
            if (!socket || !isConnected) {
                logMessage('Not connected to server', 'error');
                return;
            }
            
            if (!jwtToken.value) {
                logMessage('No token provided for authentication', 'error');
                return;
            }
            
            socket.emit('authenticate', { token: jwtToken.value }, (response) => {
                logMessage(`Authentication response: ${JSON.stringify(response)}`, 'received');
                
                if (response && response.status === 'success') {
                    isAuthenticated = true;
                    updateButtonStates();
                }
            });
        });
        
        joinRoomBtn.addEventListener('click', () => {
            if (!socket || !isConnected || !isAuthenticated) {
                logMessage('Not connected or not authenticated', 'error');
                return;
            }
            
            const room = roomName.value.trim();
            if (!room) {
                logMessage('Room name is required', 'error');
                return;
            }
            
            socket.emit('join_room', { room }, (response) => {
                logMessage(`Join room response: ${JSON.stringify(response)}`, 'received');
            });
        });
        
        sendEventBtn.addEventListener('click', () => {
            if (!socket || !isConnected || !isAuthenticated) {
                logMessage('Not connected or not authenticated', 'error');
                return;
            }
            
            const eventName = wsEventName.value.trim();
            if (!eventName) {
                logMessage('Event name is required', 'error');
                return;
            }
            
            let eventPayload;
            try {
                eventPayload = JSON.parse(wsEventPayload.value);
            } catch (err) {
                logMessage('Invalid JSON payload', 'error');
                return;
            }
            
            const data = {
                event: eventName,
                payload: eventPayload
            };
            
            logMessage(`Sending event: ${JSON.stringify(data)}`, 'sent');
            
            socket.emit('incoming_event', data, (response) => {
                logMessage(`Event response: ${JSON.stringify(response)}`, 'received');
            });
        });
        
        clearMessagesBtn.addEventListener('click', () => {
            messagesDiv.innerHTML = '';
        });
        
        // Helper function to log messages
        function logMessage(message, type) {
            const timestamp = new Date().toLocaleTimeString();
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type || 'system'}`;
            
            // Format message if it's a JSON string
            if (typeof message === 'string' && message.startsWith('{') && message.endsWith('}')) {
                try {
                    const jsonObj = JSON.parse(message);
                    message = JSON.stringify(jsonObj, null, 2);
                } catch (e) {
                    // Keep as is if not valid JSON
                }
            }
            
            messageDiv.innerHTML = `
                <div class="timestamp">${timestamp} - ${type || 'system'}</div>
                <div class="content">${message}</div>
            `;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        // Update button states based on connection and authentication status
        function updateButtonStates() {
            connectBtn.disabled = isConnected;
            disconnectBtn.disabled = !isConnected;
            wsAuthenticateBtn.disabled = !isConnected || isAuthenticated || authMethod.value === 'connection';
            joinRoomBtn.disabled = !isConnected || !isAuthenticated;
            sendEventBtn.disabled = !isConnected || !isAuthenticated;
        }
        
        // Initialize the UI
        window.onload = () => {
            broadcastParams.style.display = 'none';
        };
    </script>
</body>
</html>
